name: Test Actions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  validate-actions:
    name: Validate Action Definitions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate action.yml files
        run: |
          echo "üîç Validating action.yml files..."

          ERRORS=0
          for action_file in actions/*/action.yml; do
            echo "Checking $action_file..."

            # Check if file exists
            if [ ! -f "$action_file" ]; then
              echo "‚ùå Missing action.yml in $(dirname "$action_file")"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Validate YAML syntax
            if ! yq eval '.' "$action_file" > /dev/null 2>&1; then
              echo "‚ùå Invalid YAML in $action_file"
              ERRORS=$((ERRORS + 1))
              continue
            fi

            # Check required fields
            NAME=$(yq eval '.name' "$action_file")
            DESC=$(yq eval '.description' "$action_file")
            RUNS=$(yq eval '.runs.using' "$action_file")

            if [ "$NAME" = "null" ]; then
              echo "‚ùå Missing 'name' in $action_file"
              ERRORS=$((ERRORS + 1))
            fi

            if [ "$DESC" = "null" ]; then
              echo "‚ùå Missing 'description' in $action_file"
              ERRORS=$((ERRORS + 1))
            fi

            if [ "$RUNS" != "composite" ]; then
              echo "‚ùå Expected 'runs.using: composite' in $action_file"
              ERRORS=$((ERRORS + 1))
            fi

            echo "‚úÖ $action_file is valid"
          done

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå Found $ERRORS validation errors"
            exit 1
          else
            echo "‚úÖ All action files are valid"
          fi
